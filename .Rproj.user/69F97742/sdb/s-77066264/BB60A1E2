{
    "contents" : "$(function() {\n  \n  var campaign_urn;\n  var campaigndata = {};\n  var today = new Date();\n  var serverurl = location.protocol + \"//\" + location.host + \"/app\"\n  \n  function loadcampaign(){\n    $(\"#surveyfield\").empty();\n    if(!campaign_urn) {\n      $(\"#campaigngroup\").addClass(\"has-error\");\n      return;\n    }\n    if(campaigndata[campaign_urn]){\n      populatesurvey(campaigndata[campaign_urn]);\n    } else {\n      var mydata = {};\n      oh.campaign.read(campaign_urn, \"xml\", function(res){\n        var xml = $(jQuery.parseXML(res));\n        $.each($(\"survey\", xml), function(i, survey){\n          var promptdata = {}\n          var prompts = $(\">contentList>prompt\", survey);        \n          $.each(prompts, function(i, prompt){\n            var promptid = $(\">id\",prompt).text();\n            promptdata[promptid] = {\n              id : promptid,\n              promptType : $(\">promptType\", prompt).text(),\n              promptlabel : $(\">displayLabel\", prompt).text()\n            };\n          });\n          var surveyid = $(\">id\", survey).text();\n          mydata[surveyid] = {\n            id : surveyid,\n            title : $(\">title\", survey).text(),\n            prompts : promptdata\n          };\n        });\n        \n        //recursive in case user changed selection in the mean time        \n        campaigndata[campaign_urn] = mydata;\n        loadcampaign();\n      });\n    }\n  }\n  \n  function populatesurvey(mydata){\n    $.each(mydata, function(i, survey){\n      $(\"#surveyfield\").append($(\"<option>\").val(survey.id).text(survey.title));\n    });\n    populatevars();\n  }\n  \n  function populatevars(){\n    var mydata = campaigndata[campaign_urn];\n    var surveyid = $(\"#surveyfield\").val();\n    $(\"#xfield\").empty().append($(\"<option>\")).append($(\"<option>\").text(\"Date\")).append($(\"<option>\").text(\"Time\"));\n    $(\"#yfield\").empty().append($(\"<option>\"));\n    $(\"#colorfield\").empty().append($(\"<option>\"));\n    $(\"#sizefield\").empty().append($(\"<option>\"));   \n    $(\"#facetfield\").empty().append($(\"<option>\"));     \n    $.each(mydata[surveyid].prompts, function(i, val){\n      $(\"#xfield\").append($(\"<option>\").val(\"prompt.id.\" + val.id).text(val.promptlabel));\n      $(\"#yfield\").append($(\"<option>\").val(\"prompt.id.\" + val.id).text(val.promptlabel));  \n      $(\"#colorfield\").append($(\"<option>\").val(\"prompt.id.\" + val.id).text(val.promptlabel));   \n      $(\"#sizefield\").append($(\"<option>\").val(\"prompt.id.\" + val.id).text(val.promptlabel)); \n      $(\"#facetfield\").append($(\"<option>\").val(\"prompt.id.\" + val.id).text(val.promptlabel));        \n    });\n  }\n  \n  function getdata(cb){\n    return opencpu.r_fun_call(\"getdata\", {\n      campaign_urn : campaign_urn,\n      serverurl : serverurl,\n      token : $.cookie(\"auth_token\"),\n      start_date : $(\"#fromfield\").val(),\n      end_date : $(\"#tofield\").val()\n    }, cb);\n  }\n  \n  function makeplot(data){\n    var args = {\n      data : data,\n      x : new opencpu.Snippet($(\"#xfield\").val())\n    };\n    \n    //setting optional arguments\n    if($(\"#yfield\").val()){\n      args.y = new opencpu.Snippet($(\"#yfield\").val());\n    }\n    \n    if($(\"#colorfield\").val()){\n      args.color = new opencpu.Snippet($(\"#colorfield\").val());\n    }    \n    \n    if($(\"#sizefield\").val()){\n      args.size = new opencpu.Snippet($(\"#sizefield\").val());\n    }        \n    \n    if($(\"#facetfield\").val()){\n      args.facets = new opencpu.Snippet(\"~\" + $(\"#facetfield\").val());\n    }      \n    \n    return $(\"#plotdiv\").r_fun_plot(\"makeplot\", args);\n  }\n  \n  $(\"#plotbutton\").on(\"click\", function(){\n    if(!campaign_urn) {\n      $(\"#campaigngroup\").addClass(\"has-error\");\n      return;\n    }\n    \n    $(\"#plotbutton\").attr(\"disabled\", \"disabled\");    \n    var req1 = getdata(function(session){\n      var req2 = makeplot(session).fail(function(){\n        alert(\"Failed to make plot: \" + req2.responseText);\n      });\n    }).fail(function(){\n      alert(\"Failed to download data from Ohmage: \" + req1.responseText);\n      $(\"#plotbutton\").removeAttr(\"disabled\");\n    }).done(function(){\n      $(\"#plotbutton\").removeAttr(\"disabled\")\n    });\n  });\n  \n  $(\"#campaignfield\").change(function(){\n    campaign_urn = $(\"#campaignfield option:selected\").val();\n    if(campaign_urn){\n      $(\"#campaigngroup\").removeClass(\"has-error\");\n    }\n    loadcampaign()\n  })\n  \n  //init page\n\toh.ping(function(){\n\t\toh.user.whoami(function(x){\n      $(\"#username\").text(x);\n      \n      //populate campaign dropdown\n\t\t\toh.user.info(function(data){\n        $.each(data[x].campaigns, function(urn, title){\n          $(\"#campaignfield\").append($(\"<option>\").text(title).attr(\"value\", urn));\n        });\n        $(\"#campaignfield\").val(\"\");\n\t\t\t});\n\t\t});\n\t});\n  \n  $(\"#paramform .input-append.date\").datepicker({format: \"yyyy-mm-dd\"});\n  $(\"#tofield\").val(today.getFullYear() + \"-\" + zeroFill(today.getMonth()+1, 2) + \"-\" + zeroFill(today.getDate(),2)); \n  $(\"#plotdiv\").resizable();\n  $(\"#surveyfield\").change(populatevars);\n  \n});\n\nfunction zeroFill( number, width ) {\n  width -= number.toString().length;\n  if ( width > 0 ) {\n    return new Array( width + (/\\./.test( number ) ? 2 : 1) ).join( '0' ) + number;\n  }\n  return number + \"\"; // always return a string\n}\n",
    "created" : 1380912227042.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2876939299",
    "id" : "BB60A1E2",
    "lastKnownWriteTime" : 1380913305,
    "path" : "~/workspace/plotbuilder/inst/www/js/app.js",
    "project_path" : "inst/www/js/app.js",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "js"
}